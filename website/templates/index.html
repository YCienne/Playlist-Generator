<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>AI Emotion-Based Playlist Generator</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    </head>
    <body>
        <video autoplay loop id="backgroundVideo">
            <source src="{{ url_for('static', filename='background.mp4') }}" type="video/mp4"> 
        </video>
        <button id="playAudioBtn" class="btn mt-5">Play Music</button>


        <div class="container text-center mt-5">
            <h1 class="app-title">Mood Playlist Creator</h1>
            <p class="app-subtitle">Upload a selfie and I'll suggest the perfect playlists for your mood</p>

            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" id="imageInput" class="form-control" accept="image/*" required>
                <button type="button" class="btn btn-primary mt-3" onclick="detectEmotion()">Create Playlist</button>
            </form>

            <div id="loadingIndicator" class="loading-container">
                <img src="{{ url_for('static', filename='cool.gif') }}" alt="Loading..." class="loading-gif">
            </div>

            <div id="results" class="mt-4" style="display: none;">
                <h2>Detected Emotion: <span id="emotion"></span></h2>
                <p id="musicMood"></p>
                <div id="playlistSection" class="playlist-container" style="display: none;">
                    <h3>Suggested Playlists</h3>
                    <div id="playlistTemplate" class="playlist-card" style="display: none;">
                        <img src="" class="playlist-image" alt="Playlist Image">
                        <h4 class="playlist-name"></h4>
                        <a class="playlist-link btn btn-primary" target="_blank"><img src="{{ url_for('static', filename='wave.gif') }}" class="icon">  Listen on Spotify</a>
                    </div>

                    <div id="playlistContainer"></div> 
                </div>
                
            </div>
        </div>

        <script>
            async function detectEmotion(){
                let imageInput = document.getElementById("imageInput").files[0];
                if (!imageInput) {
                    alert("Please upload an image");
                    return;
                }
                
                let formData = new FormData();
                formData.append("image", imageInput);
                document.getElementById("loadingIndicator").style.display = "block";
                document.getElementById("results").style.display = "none";

                try {
                    const response = await fetch("/detect-emotion", {
                        method: "POST",
                        body: formData
                    });
                
                    const data = await response.json();
                    document.getElementById("loadingIndicator").style.display = "none";
                
                    if (data.error) {
                        alert("Error: " + data.error);
                        return;
                    }
                
                    document.getElementById("emotion").innerText = data.emotion;
                    document.getElementById("musicMood").innerText = data.music_mood;
                    document.getElementById("results").style.display = "block";
                
                    let playlistContainer = document.getElementById("playlistContainer");
                    playlistContainer.innerHTML = ""; 

                    if (data.playlists && data.playlists.length > 0) {
                        data.playlists.forEach(playlist => {
                            if (!playlist.name || !playlist.url) return;

                            let template = document.getElementById("playlistTemplate");
                            if (!template) {
                                console.error("Playlist template not found!");
                                return;
                            }

                        let playlistClone = template.cloneNode(true);
                        playlistClone.style.display = "block";
                        playlistClone.querySelector(".playlist-image").src = playlist.image;
                        playlistClone.querySelector(".playlist-name").innerText = playlist.name;
                        playlistClone.querySelector(".playlist-link").href = playlist.url;

                        playlistContainer.appendChild(playlistClone);
            });
                    
                        playlistSection.style.display = "block";  
                    } else {
                        playlistSection.innerHTML = "<p>No playlists found.</p>";
                    }
                } catch (error) { 
                    document.getElementById("loadingIndicator").style.display = "none";
                    alert("Something went wrong. Please try again.");
                    console.error(error);
                }
            }

            document.addEventListener("DOMContentLoaded", function () {
                let video = document.getElementById("backgroundVideo");
        
                let playPromise = video.play();
        
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log("Background music playing!");
                    }).catch(error => {
                        console.log("Autoplay blocked. User interaction required.");
                    });
                }
            });

            document.getElementById("playAudioBtn").addEventListener("click", function () {
                let video = document.getElementById("backgroundVideo");
                video.muted = false;
                video.play();
                this.style.display = "none"; 
            });
                
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>